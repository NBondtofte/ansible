---
- name: Create new Proxmox VM (REST API)
  hosts: local
  gather_facts: false

  vars:
    # AUTH
    api_host: "{{ pve_host }}"
    api_user: "{{ pve_user }}"
    api_token_name: "{{ pve_token_name }}"
    api_token_value: "{{ pve_token_value }}"
    api_token_header: "PVEAPIToken={{ api_user }}!{{ api_token_name }}={{ api_token_value }}"

    # VM SETTINGS
    vm_name_final: "{{ survey_vm_name | default(vm_name) }}"
    vm_cores_final: "{{ survey_vm_cores | default(vm_cores) }}"
    vm_memory_final: "{{ survey_vm_memory | default(vm_memory) }}"
    vm_disk_final: "{{ survey_vm_disk | default(vm_disk_gb) }}"
    vm_bridge_final: "{{ survey_vm_bridge | default(vm_bridge) }}"
    vm_node_final: "{{ pve_node }}"
    vm_storage_final: "vm_storage"

  tasks:

    #################################################################
    # 1. Show settings
    #################################################################
    - name: Show parameters
      debug:
        msg:
          host: "{{ api_host }}"
          name: "{{ vm_name_final }}"
          cores: "{{ vm_cores_final }}"
          memory: "{{ vm_memory_final }}"
          disk: "{{ vm_disk_final }}"
          bridge: "{{ vm_bridge_final }}"
          node: "{{ vm_node_final }}"
          storage: "{{ vm_storage_final }}"
          override: "{{ vmid_override | default('none') }}"

    #################################################################
    # 2. VMID handling (FULL SAFE VERSION)
    #################################################################

    # Ensure override exists as an empty string if not defined
    - name: Normalize override value
      set_fact:
        vmid_override_value: "{{ vmid_override | default('') }}"

    # If override is not empty → use it
    - name: Apply override VMID
      set_fact:
        new_vmid: "{{ vmid_override_value }}"
      when: vmid_override_value | length > 0

    # If override is empty → call Proxmox API
    - name: Get next free VMID
      uri:
        url: "https://{{ api_host }}:8006/api2/json/cluster/nextid"
        method: GET
        validate_certs: no
        headers:
          Authorization: "{{ api_token_header }}"
      register: nextid_result
      when: vmid_override_value | length == 0

    # Set VMID from API
    - name: Set auto VMID
      set_fact:
        new_vmid: "{{ nextid_result.json.data }}"
      when: vmid_override_value | length == 0

    - name: Debug final VMID
      debug:
        msg: "FINAL VMID = {{ new_vmid }}"

    #################################################################
    # 3. Create VM shell
    #################################################################
    - name: Create VM shell
      uri:
        url: "https://{{ api_host }}:8006/api2/json/nodes/{{ vm_node_final }}/qemu"
        method: POST
        validate_certs: no
        headers:
          Authorization: "{{ api_token_header }}"
        body_format: form-urlencoded
        body:
          vmid: "{{ new_vmid }}"
          name: "{{ vm_name_final }}"
          cores: "{{ vm_cores_final }}"
          memory: "{{ vm_memory_final }}"
          scsihw: virtio-scsi-pci
          ostype: l26
          agent: 1
          balloon: 0
      register: create_vm

    #################################################################
    # 4. Add disk
    #################################################################
    - name: Add VM disk
      uri:
        url: "https://{{ api_host }}:8006/api2/json/nodes/{{ vm_node_final }}/qemu/{{ new_vmid }}/config"
        method: PUT
        validate_certs: no
        headers:
          Authorization: "{{ api_token_header }}"
        body_format: form-urlencoded
        body:
          scsi0: "{{ vm_storage_final }}:{{ vm_disk_final }}G"
      register: disk_result

    #################################################################
    # 5. Add network
    #################################################################
    - name: Add network interface
      uri:
        url: "https://{{ api_host }}:8006/api2/json/nodes/{{ vm_node_final }}/qemu/{{ new_vmid }}/config"
        method: PUT
        validate_certs: no
        headers:
          Authorization: "{{ api_token_header }}"
        body_format: form-urlencoded
        body:
          net0: "virtio,bridge={{ vm_bridge_final }}"
      register: net_result

    #################################################################
    # 6. Output
    #################################################################
    - name: VM created successfully
      debug:
        msg:
          vmid: "{{ new_vmid }}"
          name: "{{ vm_name_final }}"
          node: "{{ vm_node_final }}"
          storage: "{{ vm_storage_final }}"
          bridge: "{{ vm_bridge_final }}"
