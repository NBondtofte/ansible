---
- name: Test Proxmox API connection
  hosts: local
  gather_facts: no

  vars:
    pve_host: "{{ pve_host }}"
    pve_user: "{{ pve_user }}"
    pve_token_name: "{{ pve_token_name }}"
    pve_token_value: "{{ pve_token_value }}"

  tasks:

    - name: Call Proxmox API using Python
      shell: |
        /opt/ansible-venv/bin/python3 << 'EOF'
        from proxmoxer import ProxmoxAPI
        import json

        p = ProxmoxAPI(
            "{{ pve_host }}",
            user="{{ pve_user }}",
            token_name="{{ pve_token_name }}",
            token_value="{{ pve_token_value }}",
            verify_ssl=False
        )

        nodes = [n["node"] for n in p.nodes.get()]
        print(json.dumps(nodes))
        EOF
      register: pve_python_output

    - name: Show Proxmox nodes
      debug:
        msg: "Cluster nodes: {{ pve_python_output.stdout }}"
