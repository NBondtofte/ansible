---
- name: Test Proxmox API Connection
  hosts: local
  gather_facts: no

  vars:
    pve_host: "{{ pve_host }}"
    pve_user: "{{ pve_user }}"
    pve_token_name: "{{ pve_token_name }}"
    pve_token_value: "{{ pve_token_value }}"

  tasks:

    - name: Test Proxmox API via Python lookup
      set_fact:
        pve_nodes: >-
          {{ lookup('pipe', 
          'bash -c "python3 << EOF
from proxmoxer import ProxmoxAPI
p = ProxmoxAPI(
    \'' + pve_host + '\',
    user=\'' + pve_user + '\',
    token_name=\'' + pve_token_name + '\',
    token_value=\'' + pve_token_value + '\',
    verify_ssl=False
)
print([n[\"node\"] for n in p.nodes.get()])
EOF"') }}

    - name: Print Proxmox nodes
      debug:
        msg: "Cluster nodes: {{ pve_nodes }}"
